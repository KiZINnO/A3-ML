name: Continuous Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set Up SSH Keys and Config
        run: |
          mkdir -p ~/.ssh
          # Write the bazooka key
          echo "${{ secrets.BAZOOKA_SSH_KEY }}" > ~/.ssh/bazooka_key
          # Write the mlbrain key
          echo "${{ secrets.MLBRAIN_SSH_KEY }}" > ~/.ssh/mlbrain_key
          chmod 600 ~/.ssh/bazooka_key ~/.ssh/mlbrain_key

          # Create SSH config with both bazooka and mlbrain settings.
          echo "Host bazooka
    HostName ${{ secrets.BAZOOKA_HOST }}
    Port ${{ secrets.BAZOOKA_PORT }}
    User ${{ secrets.BAZOOKA_USER }}
    IdentityFile ~/.ssh/bazooka_key
    IdentityOnly yes" > ~/.ssh/config

          echo "Host mlbrain
    HostName ${{ secrets.MLBRAIN_HOST }}
    User ${{ secrets.MLBRAIN_USER }}
    IdentityFile ~/.ssh/mlbrain_key
    ProxyJump bazooka" >> ~/.ssh/config

          chmod 600 ~/.ssh/config

      - name: Deploy to Server via SSH
        run: |
          # This command connects to mlbrain (via bazooka) and executes deployment commands.
          ssh mlbrain -p ${{ secrets.MLBRAIN_PORT }} "cd /path/to/your/project && docker-compose -f docker-compose-prod.yaml pull && docker-compose -f docker-compose-prod.yaml up -d"